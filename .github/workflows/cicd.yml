name: CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  packages: read

env:
  PYTHON_VERSION: "3.9"

jobs:
  validation:
    name: Validation (lint/format/typecheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dev dependencies (api + front)
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt -r api/requirements-dev.txt
          pip install -r front/requirements.txt -r front/requirements-dev.txt

      - name: Black (check)
        run: black --check .

      - name: Flake8
        run: flake8

      - name: Mypy
        run: mypy api front

  tests:
    name: Tests (unit/integration/e2e)
    runs-on: ubuntu-latest
    needs: [validation]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dev dependencies (api + front)
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt -r api/requirements-dev.txt
          pip install -r front/requirements.txt -r front/requirements-dev.txt

      - name: Unit tests (coverage)
        run: |
          pytest --cov=api --cov=front --cov-report=term-missing -m "not integration and not e2e"

      - name: Start stack (Docker Compose) for integration + e2e
        run: |
          FRONT_PORT=8080 docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --build

      - name: Integration tests (DB)
        env:
          DB_HOST: localhost
          DB_NAME: forum
          DB_USER: postgres
          DB_PASSWORD: password
        run: |
          pytest -m integration

      - name: Install Playwright (for E2E)
        run: |
          pip install playwright
          python -m playwright install --with-deps chromium

      - name: E2E tests (against Docker Compose)
        env:
          E2E_BASE_URL: http://localhost:8080
        run: |
          pytest -m e2e

      - name: Compose logs on failure
        if: failure()
        run: FRONT_PORT=8080 docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color

      - name: Stop stack
        if: always()
        run: FRONT_PORT=8080 docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

  build:
    name: Build & Push images (GHCR)
    runs-on: ubuntu-latest
    needs: [tests]
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute short SHA & Lowercase REPO
        id: vars
        run: |
          echo "sha7=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "repo_lower=${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push api
        uses: docker/build-push-action@v6
        with:
          context: ./api
          push: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.repo_lower }}/api:${{ steps.vars.outputs.sha7 }}

      - name: Build & push front
        uses: docker/build-push-action@v6
        with:
          context: ./front
          push: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.repo_lower }}/front:${{ steps.vars.outputs.sha7 }}

      - name: Build & push db
        uses: docker/build-push-action@v6
        with:
          context: ./db
          push: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.repo_lower }}/db:${{ steps.vars.outputs.sha7 }}

  deploy:
    name: Deploy (Docker Swarm via SSH)
    runs-on: ubuntu-latest
    needs: [build]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute short SHA & Lowercase REPO
        id: vars
        run: |
          echo "sha7=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "repo_lower=${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

      - name: Setup SSH (manager)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy stack file to manager
        run: |
          scp -i ~/.ssh/id_rsa docker-stack.yml "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/docker-stack.yml"

      - name: Deploy stack on manager
        env:
          SHA7: ${{ steps.vars.outputs.sha7 }}
          REPO: ${{ steps.vars.outputs.repo_lower }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "\
            set -euo pipefail; \
            echo \"$GHCR_TOKEN\" | docker login ghcr.io -u '${{ github.repository_owner }}' --password-stdin; \
            docker secret inspect forum_db_password >/dev/null 2>&1 || printf 'password' | docker secret create forum_db_password - >/dev/null; \
            IMAGE_TAG=$SHA7 REPO=$REPO docker stack deploy -c ~/docker-stack.yml forum-anonyme --with-registry-auth \
          "
